% This file defines the `exmath` package
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{exmath}[2020/11/12 Extended math commands]

% Multilingual support
\def\@theorem@mark{}
\def\@definition@mark{}
\def\@proposition@mark{}
\def\@lemma@mark{}
\def\@corollary@mark{}
\def\@proof@mark{}
\def\@example@mark{}

\def\@note@mark{}
\def\@notation@mark{}
\def\@remark@mark{}
\def\@claim@mark{}

\newif\if@removechapters

\DeclareOption{en}{%
    \def\@theorem@mark{Theorem}
    \def\@definition@mark{Definition}
    \def\@proposition@mark{Proposition}
    \def\@lemma@mark{Lemma}
    \def\@corollary@mark{Corollary}
    \def\@proof@mark{Proof}
    \def\@example@mark{Example}

    \def\@note@mark{Note}
    \def\@notation@mark{Notation}
    \def\@remark@mark{Remark}
    \def\@claim@mark{Afirmación}
}

\DeclareOption{es}{%
    \def\@theorem@mark{Teorema}
    \def\@definition@mark{Definición}
    \def\@proposition@mark{Proposición}
    \def\@lemma@mark{Lema}
    \def\@corollary@mark{Corolario}
    \def\@proof@mark{Demostración}
    \def\@example@mark{Ejemplo}

    \def\@note@mark{Nota}
    \def\@notation@mark{Notación}
    \def\@remark@mark{Observación}
    \def\@claim@mark{Claim}
}

\DeclareOption{chapters}{\@removechaptersfalse}
\DeclareOption{nochapters}{\@removechapterstrue}

\ExecuteOptions{en, chapters}
\ProcessOptions\relax

\RequirePackage{amsmath, amssymb, amsthm, amsfonts} % Meth stuff
\RequirePackage{systeme} % Systems of equations
\RequirePackage{cancel} % Cancel an expression with an arrow
\RequirePackage{siunitx} % Units
\RequirePackage{bm} % Bold math
\RequirePackage{bbm} % More bold math
\RequirePackage{mathpazo} % Fixes stuff
\RequirePackage{mathtools} % Fixes more stuff

\RequirePackage[framemethod=TikZ]{mdframed} % Frames for theorems, proofs, etc.
\RequirePackage{xargs}
\RequirePackage{imakeidx} % Create indexes
\RequirePackage{tocloft} % Tables of content
\RequirePackage{ifthen} % If then else structure
\RequirePackage{xspace} % Fix space after some commands
\RequirePackage{etoolbox} % Fix stuff

\if@removechapters
    \numberwithin{equation}{section}
\fi

\DeclareSymbolFont{bbold}{U}{bbold}{m}{n}
\DeclareSymbolFontAlphabet{\mathbbold}{bbold}

\let\svlim\lim\def\lim{\svlim\limits} % Put x\to\infty below \lim

\let\implies\Longrightarrow % Implies
\let\nimplies\nLongrightarrow % Not implies
\let\impliedby\Longleftarrow % Implied by
\let\nimpliedby\nLongleftarrow % Not implied by
\let\iff\Longleftrightarrow % If and only if

\let\epsilon\varepsilon % Actual epsilon

% Cooler greater (lower) or equal to symbols
\let\leq\leqslant
\let\nleq\nleqslant
\let\geq\geqslant
\let\ngeq\ngeqslant

\let\lor\vee % Logical AND
\let\land\wedge % Logical OR

\newcommand{\mop}[1]{\mathrm{#1}\xspace} % Operation

% Define number sets
\newcommand{\N}{\ensuremath{\mathbb{N}}\xspace}
\newcommand{\Z}{\ensuremath{\mathbb{Z}}\xspace}
\newcommand{\Q}{\ensuremath{\mathbb{Q}}\xspace}
\newcommand{\R}{\ensuremath{\mathbb{R}}\xspace}
\newcommand{\C}{\ensuremath{\mathbb{C}}\xspace}
\renewcommand{\O}{\ensuremath{\emptyset}\xspace}

\newcommand{\st}{\; | \;}
\newcommand{\wtf}{(?)}

% Special characters
\newcommand{\qeq}{\overset{?}{=}}

% Operators
\newcommand{\comb}[2]{\left( \begin{matrix} #1 \\ #2 \end{matrix} \right)}
\renewcommand{\abs}[1]{\left\vert #1 \right\vert}
\newcommand{\conj}[1]{\overline{#1}}
\newcommand{\floor}[1]{\left\lfloor #1 \right\rfloor}
\newcommand{\gea}[1]{\underset{\longrightarrow}{#1}}

\DeclareMathOperator{\rg}{Rg}
\DeclareMathOperator{\rankm}{Rank}

% Mathematical analysis
%\newcommand{\grad}{\nabla}
\newcommand{\bigzero}{\text{\Large O}}
\newcommand{\invers}[1]{#1 ^{-1}}

\newcommand{\deriv}[2]{\frac{\dif #1}{\dif #2}} % 1: f; 2: var
\newcommand{\liminft}[1]{\lim_{{#1}\rightarrow\infty}}
\newcommand{\mylim}[3]{\lim_{#1 \rightarrow #2} #3} % 1: vec; 2: to; 3: var;

\DeclareMathOperator{\rot}{rot}
\DeclareMathOperator{\diver}{div}

\renewcommand{\vec}[1]{\mathbf{#1}}
\newcommand{\vect}[1]{\begin{bmatrix} #1 \end{bmatrix}}
\newcommand{\vectt}[1]{\left( #1 \right)^t}

% Set theory and relations
\newcommand{\set}[1]{\{ #1 \}}
\newcommand{\x}{\times} % Cool x
\newcommand{\appl}[3]{#1 : #2\longrightarrow #3} % Application
\newcommand{\stdf}{\ensuremath{\appl{f}{X}{Y}}} % Casual function
\newcommand{\uexists}{\exists\, !\;} % Exists and it's unique
\newcommand{\rela}{\mathcal{R}} % Relation
\newcommand{\parts}[1]{\mathcal{P}\left( #1 \right)} % Partitions of a set / Power set
\newcommand{\uset}{\mathcal{U}} % Universal set
\newcommand{\SP}{\ensuremath{\mathcal{P}}}

\newcommand{\Rtn}{\R^n}
\newcommand{\field}{\ensuremath{\mathbb{F}}\xspace}

\newcommand{\mtrans}[1]{{#1}^{T}}

\newcommand{\eqreason}[2][=]{\underset{%
	\substack{
		\vspace{6pt} \uparrow  \\
		\mathrlap{\wrapreasontext{#2}}
	}
}{#1}}

\newcommand{\eqreasonup}[2][=]{\overset{%
	\substack{
		\mathrlap{\wrapreasontext{#2}} \\
		\vspace{4pt} \downarrow
	}
}{#1}}

% VECTORS AND GEOMETRY
% Dot product
\newcommand{\dotp}[1]{\langle #1 \rangle}
\newcommand{\dotpm}[2]{\dotp{#1, #2}}
\newcommand{\gen}[1]{\mathopen{<} #1 \mathclose{>}} % Generated by
% Norm of a vector
\newcommand{\vnorm}[1]{||#1||}

% Real analysis
\newcommand{\minuszero}{\setminus\set{0}}
\newcommand{\bydef}{\overset{\mathrm{def}}{=}}
\newcommand{\iffdef}{\overset{\mathrm{def}}{\iff}}

\newenvironment{rcases}{\left.\begin{aligned}}{\end{aligned}\right\rbrace}
\newenvironment{lcases}{\left\lbrace\begin{aligned}}{\end{aligned}\right.}
\newenvironment{lrcases}{\left\lbrace\begin{aligned}}{\end{aligned}\right\rbrace}

% Theorem, lemmas, etc. environment definitions.

\if@removechapters
    \newcounter{thm}[section] \setcounter{thm}{0}
    \newcounter{def}[section] \setcounter{def}{0}
    \renewcommand{\thethm}{\thesection.\arabic{thm}}
    \renewcommand{\thedef}{\thesection.\arabic{def}}
    \numberwithin{thm}{section}
    \message{Using section numbering for theorems and definitions}
\else
    \newcounter{thm}[chapter] \setcounter{thm}{0}
    \newcounter{def}[chapter] \setcounter{def}{0}
    \renewcommand{\thethm}{\thechapter.\arabic{thm}}
    \renewcommand{\thedef}{\thechapter.\arabic{def}}
    \numberwithin{thm}{chapter}
    \message{Using chapter numbering for theorems and definitions}
\fi

% https://tex.stackexchange.com/a/17551
\newtheoremstyle{highlight}
  {\topsep}   % ABOVESPACE
  {\topsep}   % BELOWSPACE
  {\itshape}  % BODYFONT
  {0pt}       % INDENT (empty value is the same as 0pt)
  {\bfseries} % HEADFONT
  {.}         % HEADPUNCT
  {5pt plus 1pt minus 1pt} % HEADSPACE
  {\thmname{#1}\thmnumber{ #2}\thmnote{ (#3)}} % CUSTOM-HEAD-SPEC

\newtheoremstyle{defi}
  {15pt}   % ABOVESPACE
  {2pt}   % BELOWSPACE
  {\itshape}  % BODYFONT
  {0pt}       % INDENT (empty value is the same as 0pt
  {\bfseries} % HEADFONT
  {.}         % HEADPUNCT
  {5pt plus 1pt minus 1pt} % HEADSPACE
  {\thmname{#1}\thmnumber{ #2}\thmnote{ (#3)}} % CUSTOM-HEAD-SPEC

\theoremstyle{remark}

\newtheorem*{note}{\@note@mark}
\newtheorem*{notation}{\@notation@mark}
\newtheorem*{claim}{\@claim@mark}

% Define a List of Theorems. ithm is a special counter which
% is incremented when a new item is added to this list, that
% is saved in the master.ithmc file. To this list is only added
% the theorems, lemmas and propositions that have a special name.
\newcommand{\listtheoremname}{List of Theorems}
\newlistof[chapter]{ithm}{ithmc}{\listtheoremname}
\newcommand{\listoftheorems}{\listofithm}

% Helper macro to increment the ithm counter and add the entry to the list.
\newcommand{\ithm}[1]{%
	\refstepcounter{ithm}
	\addcontentsline{ithmc}{ithm}{\protect\numberline{\theithm}#1}\par
}

% Define a List of Definitions. idef is a special counter which
% is incremented when a new item is added to this list, that
% is saved in the master.idefc file. To this list is only added
% the definitions that have a special name.
\newcommand{\listdefinitionname}{List of Definitions}
\newlistof[chapter]{idef}{idefc}{\listdefinitionname}
\newcommand{\listofdefinitions}{\listofidef}

% Helper macro to increment the idef counter and add the entry to the list.
\newcommand{\idef}[1]{%
	\refstepcounter{idef}
	\addcontentsline{idefc}{idef}{\protect\numberline{\theidef}#1}\par
}

\theoremstyle{defi}

% {defi} environment definition.
\newtheorem{idefi}[def]{\@definition@mark}
\newenvironment{defi}[1][]{%
    \vspace{2pt}
    \ifthenelse{\equal{#1}{}}{}{\idef{#1}}
    \begin{idefi}[#1]
}{\end{idefi}}

\theoremstyle{defi}

% {theorem} environment definition.
\newtheorem{itheorem}[thm]{\@theorem@mark}
\newenvironment{theorem}[1][]{%
    \vspace{2pt}
    \ifthenelse{\equal{#1}{}}{}{\ithm{#1}}
    \begin{itheorem}[#1]
}{\end{itheorem}}

% {lemma} environment definition.
\newtheorem{ilemma}[def]{\@lemma@mark}
\newenvironment{lemma}[1][]{%
    \vspace{2pt}
    \ifthenelse{\equal{#1}{}}{}{\ithm{#1}}
    \begin{ilemma}[#1]
}{\end{ilemma}}

% {prop} environment definition.
\newtheorem{iprop}[def]{\@proposition@mark}
\newenvironment{prop}[1][]{%
    \vspace{2pt}
    \ifthenelse{\equal{#1}{}}{}{\ithm{#1}}
    \begin{iprop}[#1]
}{\end{iprop}}

% {coro} environment definition.
\newtheorem{coro}[def]{\@corollary@mark}

% This macro changes the equation numbering from (\theequation)
% to (\thesection.\theequation). The equation counter is reseted
% when the section counter is incremented.
% Note: If using a LaTeX distribution older than April 2018 this
% macro won't work unless the chngctr package is used.
%
% https://tex.stackexchange.com/questions/207532/reset-equation-numbering-after-each-section
\counterwithin{equation}{chapter}

\renewcommand{\(}[1][]{\begin{equation}\ifthenelse{\equal{#1}{}}{}{\label{#1}}}
\renewcommand{\)}{\end{equation}}

\newenvironment{leftbar}{\begin{mdframed}[topline=false, rightline=false, bottomline=false,%
    linewidth=2pt, skipabove=1em, skipbelow=0pt]}{\end{mdframed}}

\renewcommand{\qedsymbol}{$\blacksquare$}
\renewenvironment{proof}{\begin{leftbar}\noindent\textit{\underline{\@proof@mark}}.\itshape }{\qed\end{leftbar}} % Proofs

\newenvironment{example}{\vspace{10pt}\par\noindent\textbf{\@example@mark}.\itshape~}{} % Examples
\newenvironment{remark}{\vspace{10pt}\par\noindent\textit{\@remark@mark}.~}{}  % Remarks

% Fix some weird spacing on boxes created by the mdframed package
% http://tex.stackexchange.com/questions/22119/how-can-i-change-the-spacing-before-theorems-with-amsthm
\makeatletter
\def\thm@space@setup{%
    \thm@preskip=\parskip \thm@postskip=0pt
}
